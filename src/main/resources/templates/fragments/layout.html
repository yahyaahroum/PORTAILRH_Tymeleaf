<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="head">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Portail-RH</title>

  <!-- ===== BLOQUER LES FICHIERS CORROMPUS AVANT TOUT ===== -->
  <script>
    // BLOQUER IMM√âDIATEMENT les fichiers corrompus
    const originalCreateElement = document.createElement;
    document.createElement = function(tagName) {
      const element = originalCreateElement.call(document, tagName);

      if (tagName.toLowerCase() === 'script') {
        const originalSetAttribute = element.setAttribute;
        element.setAttribute = function(name, value) {
          if (name === 'src' || name === 'th:src') {
            // BLOQUER les fichiers probl√©matiques
            if (value.includes('vendor.addons.js') ||
                    value.includes('core.js') ||
                    value.includes('template.js')) {
              console.warn('üö´ BLOQU√â:', value);
              return; // NE PAS charger le fichier
            }
          }
          return originalSetAttribute.call(this, name, value);
        };
      }
      return element;
    };

    console.log('üõ°Ô∏è Protection contre fichiers corrompus activ√©e');
  </script>

  <!-- CSS -->
  <link rel="stylesheet" th:href="@{/vendors/iconfonts/mdi/css/materialdesignicons.css}">
  <link rel="stylesheet" th:href="@{https://use.fontawesome.com/releases/v5.0.7/css/all.css}">
  <link rel="stylesheet" th:href="@{/vendors/css/vendor.addons.css}">
  <link th:href="@{https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css}" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/shared/style.css}">
  <link rel="stylesheet" th:href="@{/css/demo_1/style.css}">
  <link rel="shortcut icon" th:href="@{/images/favicon.ico}" />

  <!-- ===== SCRIPTS PROPRES (CDN UNIQUEMENT) ===== -->

  <!-- jQuery moderne -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- Autocomplete -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.2.27/jquery.autocomplete.min.js"></script>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ===== INITIALISATION IMM√âDIATE ===== -->
  <script>
    console.log('üöÄ D√âMARRAGE PORTAIL RH');

    // Attendre que jQuery soit charg√©
    function waitForJQuery() {
      if (typeof $ !== 'undefined') {
        console.log('‚úÖ jQuery charg√©:', $.fn.jquery);
        initializeApp();
      } else {
        console.log('‚è≥ Attente jQuery...');
        setTimeout(waitForJQuery, 50);
      }
    }

    function initializeApp() {
      $(document).ready(function() {
        console.log('üéØ Initialisation de l\'application');

        // Test Select2
        if (typeof $.fn.select2 !== 'undefined') {
          console.log('‚úÖ Select2 disponible');

          // Configuration globale Select2
          $.fn.select2.defaults.set('language', 'fr');
          $.fn.select2.defaults.set('allowClear', true);
          $.fn.select2.defaults.set('width', '100%');

          // Initialiser tous les select2
          $('.select2').each(function() {
            const $this = $(this);
            if (!$this.hasClass('select2-hidden-accessible')) {
              try {
                $this.select2({
                  placeholder: $this.attr('placeholder') || 'S√©lectionnez...'
                });
                console.log('‚úÖ Select2 initialis√© sur:', this.id || this.name || 'element');
              } catch (error) {
                console.error('‚ùå Erreur Select2 sur element:', error);
              }
            }
          });

          console.log('‚úÖ TOUS LES SELECT2 INITIALIS√âS');
        } else {
          console.error('‚ùå Select2 NON DISPONIBLE');
        }

        // Autres initialisations
        console.log('üéâ APPLICATION PR√äTE');
      });
    }

    // D√©marrer
    waitForJQuery();

    // Fonction globale pour nouveaux √©l√©ments
    window.initNewSelect2 = function(selector) {
      $(selector || '.select2').each(function() {
        const $this = $(this);
        if (!$this.hasClass('select2-hidden-accessible')) {
          $this.select2({
            placeholder: $this.attr('placeholder') || 'S√©lectionnez...',
            allowClear: true,
            width: '100%'
          });
        }
      });
    };
  </script>

  <!-- ===== EMP√äCHER LE CHARGEMENT DES SCRIPTS CORROMPUS ===== -->
  <style>
    /* Cacher visuellement les erreurs pour le moment */
    .console-error { display: none !important; }
  </style>

  <script>
    // Intercepter et bloquer les erreurs des anciens scripts
    window.addEventListener('error', function(event) {
      const errorMsg = event.message;
      const source = event.filename;

      if (source && (source.includes('vendor.addons.js') ||
              source.includes('core.js') ||
              source.includes('template.js'))) {
        console.warn('üö´ Erreur bloqu√©e de fichier corrompu:', source);
        event.preventDefault();
        return false;
      }
    });

    // Override pour √©viter les erreurs getComputedStyle
    const originalGetComputedStyle = window.getComputedStyle;
    window.getComputedStyle = function(element, pseudoElement) {
      if (!element || !element.nodeType || element.nodeType !== 1) {
        console.warn('getComputedStyle: √©l√©ment invalide ignor√©');
        return {};
      }
      return originalGetComputedStyle.call(this, element, pseudoElement);
    };
  </script>

</head>
<body>

<!-- ===== PAGE DE TEST IMM√âDIAT ===== -->
<div style="padding: 20px; max-width: 600px; margin: 0 auto; background: #f8f9fa; border: 1px solid #ddd;">
  <h2 style="color: #28a745;">üß™ Test Select2 - Version Corrig√©e</h2>

  <div style="margin: 20px 0;">
    <h4>Test 1: Select Simple</h4>
    <select id="test1" class="form-control select2" name="test1" style="width: 100%;">
      <option value="">Choisir une option...</option>
      <option value="option1">Option 1</option>
      <option value="option2">Option 2</option>
      <option value="option3">Option 3</option>
    </select>
  </div>

  <div style="margin: 20px 0;">
    <h4>Test 2: Select Multiple</h4>
    <select id="test2" class="form-control select2" name="test2" multiple style="width: 100%;">
      <option value="a">Choix A</option>
      <option value="b">Choix B</option>
      <option value="c">Choix C</option>
      <option value="d">Choix D</option>
    </select>
  </div>

  <div style="margin: 20px 0;">
    <h4>Test 3: Comme votre statut</h4>
    <select id="statut" name="statut" class="form-control select2" style="width: 100%;">
      <option value="All">Tous</option>
      <option value="Active">Actifs</option>
      <option value="Inactive">Inactifs</option>
      <option value="Pending">En attente</option>
    </select>
  </div>

  <button type="button" class="btn btn-primary" onclick="runTests()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px;">
    üöÄ TESTER MAINTENANT
  </button>

  <div id="results" style="margin-top: 20px; padding: 15px; background: white; border-radius: 4px;"></div>
</div>

<script>
  function runTests() {
    const results = document.getElementById('results');
    let html = '<h4>üîç R√©sultats des Tests :</h4>';

    // Test 1: jQuery
    if (typeof $ !== 'undefined') {
      html += '<p style="color: green;">‚úÖ jQuery: OK (version ' + $.fn.jquery + ')</p>';
    } else {
      html += '<p style="color: red;">‚ùå jQuery: NON CHARG√â</p>';
    }

    // Test 2: Select2
    if (typeof $.fn.select2 !== 'undefined') {
      html += '<p style="color: green;">‚úÖ Select2: OK</p>';
    } else {
      html += '<p style="color: red;">‚ùå Select2: NON CHARG√â</p>';
    }

    // Test 3: √âl√©ments initialis√©s
    let initCount = 0;
    $('.select2').each(function() {
      if ($(this).hasClass('select2-hidden-accessible')) {
        initCount++;
      }
    });

    if (initCount > 0) {
      html += '<p style="color: green;">‚úÖ Select2 Initialis√©: ' + initCount + ' √©l√©ments</p>';
    } else {
      html += '<p style="color: orange;">‚ö†Ô∏è Select2: Aucun √©l√©ment initialis√©</p>';
    }

    // Test 4: Valeurs
    const val1 = $('#test1').val();
    const val2 = $('#test2').val();
    const val3 = $('#statut').val();

    html += '<p><strong>Valeurs actuelles:</strong></p>';
    html += '<ul>';
    html += '<li>Test 1: ' + (val1 || 'vide') + '</li>';
    html += '<li>Test 2: ' + (val2 && val2.length ? val2.join(', ') : 'vide') + '</li>';
    html += '<li>Statut: ' + (val3 || 'vide') + '</li>';
    html += '</ul>';

    results.innerHTML = html;
  }

  // Auto-test apr√®s 2 secondes
  setTimeout(runTests, 2000);
</script>

</body>
</html>